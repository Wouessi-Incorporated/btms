<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BMTS Admin</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#0f1013;color:#f4f5f7}
    header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.12);background:rgba(15,16,19,.85);position:sticky;top:0}
    h1{margin:0;font-size:18px}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .card{border:1px solid rgba(255,255,255,.12);border-radius:14px;background:rgba(23,26,32,.9);overflow:hidden}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    select,input,textarea,button{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(5,6,10,.55);color:#f4f5f7}
    button{cursor:pointer;font-weight:700}
    button.primary{background:linear-gradient(135deg,#d2b06a,#f0e0b4);color:#1b1408;border-color:rgba(0,0,0,.08)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left;font-size:14px}
    th{color:#c9cdd6;font-weight:700}
    tr:hover{background:rgba(255,255,255,.03)}
    .muted{color:#c9cdd6}
    .split{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width: 900px){.split{grid-template-columns:1fr}}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid rgba(255,255,255,.14);border-radius:999px;color:#c9cdd6;font-size:12px}
    a{color:#f0e0b4}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>BMTS Admin â€“ Registrations</h1>
    <div class="muted" style="margin-top:6px">Use filters, review payment proofs, and confirm verification status.</div>
  </div>
</header>

<main class="wrap">
  <div class="row" style="margin-bottom:12px">
    <label class="pill">Status
      <select id="statusFilter">
        <option value="">All</option>
        <option>Pending Verification</option>
        <option>Payment Verified</option>
        <option>Payment Rejected</option>
        <option>Awaiting Resubmission</option>
      </select>
    </label>
    <button class="primary" id="refreshBtn">Refresh</button>
  </div>

  <div class="split">
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Name</th>
            <th>Email</th>
            <th>Track</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="card" style="padding:14px">
      <div style="font-weight:800;margin-bottom:8px">Selected Registration</div>
      <div id="details" class="muted">Select a row to review details.</div>

      <div id="actions" style="display:none;margin-top:12px">
        <div class="row" style="margin-bottom:10px">
          <a id="downloadLink" href="#" target="_blank" rel="noopener">Download payment proof</a>
        </div>

        <div class="row" style="margin-bottom:10px">
          <select id="newStatus">
            <option>Pending Verification</option>
            <option>Payment Verified</option>
            <option>Payment Rejected</option>
            <option>Awaiting Resubmission</option>
          </select>
          <button class="primary" id="saveBtn">Save</button>
        </div>

        <textarea id="adminNotes" rows="6" style="width:100%" placeholder="Admin notes (internal only)"></textarea>
        <div id="msg" class="muted" style="margin-top:10px"></div>
      </div>
    </div>
  </div>
</main>

<script>
  let selectedId = null;

  async function fetchJSON(url, opts){
    const res = await fetch(url, opts);
    const data = await res.json();
    if(!res.ok) throw new Error(data.message || 'Request failed');
    return data;
  }

  function escapeHtml(s){
    return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function load(){
    const status = document.getElementById('statusFilter').value;
    const q = status ? ('?status=' + encodeURIComponent(status)) : '';
    const data = await fetchJSON('/admin/api/registrations' + q);
    const tbody = document.getElementById('rows');
    tbody.innerHTML = '';
    data.rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.style.cursor='pointer';
      tr.innerHTML = `
        <td class="muted">${escapeHtml(new Date(r.created_at).toLocaleString())}</td>
        <td>${escapeHtml(r.first_name + ' ' + r.last_name)}</td>
        <td class="muted">${escapeHtml(r.email)}</td>
        <td class="muted">${escapeHtml(r.practice_track)}</td>
        <td>${escapeHtml(r.status)}</td>
      `;
      tr.addEventListener('click', ()=>select(r.id));
      tbody.appendChild(tr);
    });
  }

  async function select(id){
    selectedId = id;
    const data = await fetchJSON('/admin/api/registration/' + encodeURIComponent(id));
    const r = data.row;

    document.getElementById('actions').style.display = 'block';
    document.getElementById('newStatus').value = r.status;
    document.getElementById('adminNotes').value = r.admin_notes || '';

    document.getElementById('downloadLink').href = '/admin/api/registration/' + encodeURIComponent(id) + '/payment-proof';

    document.getElementById('details').innerHTML = `
      <div><strong>ID:</strong> ${escapeHtml(r.id)}</div>
      <div><strong>Name:</strong> ${escapeHtml(r.title + ' ' + r.first_name + ' ' + r.last_name)}</div>
      <div><strong>Email:</strong> ${escapeHtml(r.email)}</div>
      <div><strong>Telephone:</strong> ${escapeHtml(r.telephone)}</div>
      <div><strong>Company:</strong> ${escapeHtml(r.company)}</div>
      <div><strong>City:</strong> ${escapeHtml(r.city)}</div>
      <div><strong>Track:</strong> ${escapeHtml(r.practice_track)}</div>
      <div><strong>Payment Method:</strong> ${escapeHtml(r.payment_method)}</div>
      <div><strong>Status:</strong> ${escapeHtml(r.status)}</div>
    `;
    document.getElementById('msg').textContent = '';
  }

  async function save(){
    if(!selectedId) return;
    const status = document.getElementById('newStatus').value;
    const admin_notes = document.getElementById('adminNotes').value;

    const data = await fetchJSON('/admin/api/registration/' + encodeURIComponent(selectedId) + '/status', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ status, admin_notes })
    });

    document.getElementById('msg').textContent = 'Saved.';
    await load();
  }

  document.getElementById('refreshBtn').addEventListener('click', load);
  document.getElementById('saveBtn').addEventListener('click', save);
  load();
</script>
</body>
</html>
